<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/nes.css@latest/css/nes.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css">
    <title>ParkChat alfa</title>
  </head>
  <body>
        <div class="loader" id="loader">
        <img src="loader1.gif" alt="">
        </div>
    
    <header class="nes-container"> 
      <h1 id="titulo" class="title">Titulo</h1>
    </header>
      
      <div class="nes-container">
        <ul class="chat" id="chat"></ul>
      </div>
      <br>

    <div class="nes-field action" id="action">
        <label 
        for="inputNombre"
        id="name-label">Nombre 
        <input type="text" 
          id="inputNombre"
          class="nes-input" 
          value=""
          readonly>
        </label>

        <label 
        for="inputMensaje"
        id="name-label">Mensaje 
        <input type="text" 
          id="inputMensaje"
          class="nes-input"
          placeholder=" ingresa tu mensaje..." 
          required>
        </label>
        
        <div>
        <button class="nes-btn is-primary" type="submit" id="submit">Enviar</button>
        <button  class="nes-btn is-error" id="cerrarSesion">Salir</button></div>
    </div>
    
    <div class="login" id="loginGoogle">
      <!-- <img id="idImg" src="google.png" alt=""> -->
      <i id="idImg" class="nes-icon google is-large"></i>
    </div>
   

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.3/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.9.3/firebase-analytics.js";
      import { getDatabase, ref, onValue,
        onChildAdded, onChildChanged, query, orderByChild, set, push} from "https://www.gstatic.com/firebasejs/9.9.3/firebase-database.js";
      import { getAuth, signInWithPopup, GoogleAuthProvider,
      onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.9.3/firebase-auth.js";

      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries
    
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyBQHPJhety1e9KSTH1gb1k48F8RJeB1rdQ",
        authDomain: "parkchat-96817.firebaseapp.com",
        databaseURL: "https://parkchat-96817-default-rtdb.firebaseio.com",
        projectId: "parkchat-96817",
        storageBucket: "parkchat-96817.appspot.com",
        messagingSenderId: "1040529162098",
        appId: "1:1040529162098:web:c839b697a9ef654143a7eb",
        measurementId: "G-6P1XQN6HD6"
      };
    
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);

      const db = getDatabase()

      //Referencias
      const refText = ref(db, 'textos/')
      const refMensaje = ref(db, 'mensajes/')

      //Querys
      const queryMSG = query(refMensaje, orderByChild('fecha/'))

      let titulo = document.getElementById('titulo')
      let descripcion = document.getElementById('descripcion')
      let loader = document.getElementById('loader')
      let chat = document.getElementById('chat')
      let inputNombre = document.getElementById('inputNombre')
      let inputMensaje = document.getElementById('inputMensaje')
      let action = document.getElementById('action')
      let loginGoogle = document.getElementById('loginGoogle')
      let salir = document.getElementById('cerrarSesion').addEventListener('click', () => {
        deslogear()
      })
      let submit = document.getElementById('submit').addEventListener('click', () => {
        traerData()
      })

      onValue(refText, (snap)=>{
          let data = snap.val() //con metodos realtime lo hago con let no const, auque funciona igual
          //console.log('onValue', data)
          titulo.innerHTML = data.titulo
          descripcion.innerHTML = data.descripcion
          loader.style.display = 'none'
        })

/*         onChildChanged(refText, (snap) => {
            const data = snap.val()
            //console.log('onChildChanged', data)
        })  */

        /* onChildAdded(refMensaje, (snap) => {
            const data = snap.val()
            console.log('onChildAdded / refMensaje', data)
        }) */

        onChildAdded(queryMSG, (snap) => {
            let data = snap.val()
            let key = snap.key
            agregarMsg(data)
            loader.style.display = 'none'
        })

        const agregarMsg = (msg) => {
          let li = document.createElement('li')
          li.classList.add('list', 'nes-balloon')
          let txt = document.createTextNode(`${msg.autor}: ${msg.mensaje}`)
          li.appendChild(txt)
          li.setAttribute('id', msg.fecha)
          chat.appendChild(li)
          document.getElementById(msg.fecha).scrollIntoView({block: 'end', behavior: 'smooth'})
        }

        let clicks = document.addEventListener('keyup', function(event){
          if(event.keyCode == 13){
            event.preventDefault()
            document.getElementById('submit').click()
            //action.scrollIntoView(false);
            console.log('what')
          }
        })

        const traerData = () => {
          let fecha = Date.now()
          let msg = {
          'autor': inputNombre.value,
          'mensaje': inputMensaje.value,
          'fecha': fecha
        }
        if(inputMensaje.value != ''){
          push(refMensaje, msg)
        inputMensaje.value = ''
        } else{
          alert('Completa los campos')
        }
       }

       //Sign in with google
       const auth = getAuth()

       document.getElementById('idImg').addEventListener('click', () => {
        loguearUser()
      })

      const loguearUser = () => {
        auth.languageCode = 'es'
        const provider = new GoogleAuthProvider()
        signInWithPopup(auth, provider).then( (result) => {
          let logUser = {
            uid: result.user.uid,
            username: result.user.displayName,
            profilePicture: result.user.photoURL,
            email: result.user.email
          }
          inputNombre.value = result.user.displayName
          loginGoogle.style.display = 'none'
          action.style.display = 'flex'
          console.log(logUser)
        })
      }
       onAuthStateChanged(auth, (user) => {
        if (user) {
          inputNombre.value = user.displayName
          loginGoogle.style.display = 'none'
          action.style.display = 'flex'
        } else {
          null
        }
       })
       const deslogear = () => {
        signOut(auth)
          inputNombre.value = ''
          loginGoogle.style.display = 'flex'
          action.style.display = 'none'
       }

    </script>
  </body>
</html>
